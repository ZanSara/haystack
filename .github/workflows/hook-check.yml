name: Git Hooks

on:
  workflow_dispatch: # Activate this workflow manually
  pull_request:

jobs:

  # If the contributor didn't install the precommit-hooks, this check will fail.
  check:
    runs-on: ubuntu-latest
    steps:

      - uses: actions/checkout@v2

      - name: Setup Python
        uses: ./.github/actions/python_cache/

      - name: Install sndfile
        run: sudo apt update && sudo apt-get install libsndfile1 ffmpeg

      - name: Install Haystack
        run: |
          pip install --upgrade pip
          pip install -U .[all]
          pip install -U rest_api/
          pip install -U  ui/

      - name: Black
        run: black .

      - name: Tutorial Updates
        run: python .github/utils/convert_notebooks_into_webpages.py

      - name: Update OpenAPI specs
        run: python .github/utils/generate_openapi_specs.py

      - name: Update pipeline YAML schemas
        run: python .github/utils/generate_json_schema.py

      - name: Update API documentation
        run: .github/utils/pydoc-markdown.sh

      # If there is anything to commit, fail
      - name: Check status
        run: |
          if [[ `git status --porcelain` ]]; then
            git status
            echo ""
            echo "CHECK FAILED! This means that the pre-commit hooks didn't run."
            echo "Please execute:"
            echo ""
            echo "    `pre-commit install --hook-type pre-push`"
            echo ""
            echo "or see https://github.com/deepset-ai/haystack/blob/master/CONTRIBUTING.md for help."
            echo "If you encounter issues with the hook, please open an issue: https://github.com/deepset-ai/haystack/issues"
            echo ""
            exit 1
          fi
